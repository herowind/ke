{extend name="mobile@template/common"/} {block name="style"}
<style>
.weui-footer_fixed-bottom {
	bottom: 0;
}

.starter{
	position:absolute;
	width:100%;
	height:100px;
	top:20px;
	left:0;
}
.starter-template {
	width:220px;
	border-radius:5px;
	border-top:5px solid green;
	margin:auto;
	padding: 10px 15px;
	font-size:18px;
	color:#333;
	text-align: center;
	position:relative;
	background:rgba(255,255,255,0.8);
}
</style>
{/block} 
{block name="body"}
<div class="course-hd">
	<div class="course-camera">
		<video id="video" class="video" x5-playsinline="" playsinline="" webkit-playsinline="" onplay="startplay()" :src="live.member.url" :poster="school.banner" controls="controls" width="100%" style=""></video>
	</div>
</div>
<div class="school-bd">
	<div class="weui-panel weui-panel_access">
		<div class="weui-panel__bd">
			<a href="javascript:void(0);" class="weui-media-box weui-media-box_appmsg">
				<div class="weui-media-box__hd">
					<img class="weui-media-box__thumb" src="{$school.logo}">
				</div>
				<div class="weui-media-box__bd">
					<h4 class="weui-media-box__title">{$school.name}-{{live.name}}</h4>
					<p class="weui-media-box__desc">{$school.intro}</p>
				</div>
			</a>
		</div>
	</div>
	
	<div class="school-tab-content">
	<div class="weui-cells__title"><b>监控开放时间表</b></div>
	<div class="weui-cells">
		<div class="weui-cell" v-for="item in live.timesection">
			<div class="weui-cell__bd">
			  <p>{{item.w}}</p>
			</div>
			<div class="weui-cell__ft" v-if="item.is==1">{{item.o}}-{{item.c}}</div>
			<div class="weui-cell__ft" v-else>暂不开放</div>
		</div>
	</div>
	</div>
	<div class="school-tab-content">
		<article class="weui-article" v-if="school.contenttype==2">
		<div v-html="school.content"></div>
		</article>
	</div>

</div>

<div id="wechat" class='weui-popup__container'>
	<div class="weui-popup__overlay"></div>
	<div class="weui-popup__modal">
		<div class="toolbar">
			<div class="toolbar-inner">
				<a href="javascript:;" class="picker-button close-popup">关闭</a>
	            <h1 class="title">长按识别二维码</h1>
			</div>
		</div>
		<div class="modal-content" style="text-align:center;margin-top:50px;">
	          <img src='{$wechat.qrcode_url}' width='200' height='200'/>
		</div>
	</div>
</div>

<!-- 悬浮发布 -->
<div class="ui-button-float" id="publishTopic" v-on:click="doSubscribe" style="z-index:1">
	<img src="/guanke/images/icons/qrcode.png" />
</div>
<div class="weui-footer weui-footer_fixed-bottom">
	<button class="weui-btn weui-btn_primary" v-on:click="doFavor" style="border-radius: 0" v-if="isshowfavor">立即申请</button>
	<button class="weui-btn weui-btn_primary" v-on:click="doFavor" style="border-radius: 0" v-if="isshowveryfy">审核中</button>
</div>
{/block} 
{block name="script"}
<script type="text/javascript">
		var live_id = {$live_id};
		var vm = new Vue({
			el:'#app',
			data : {
				live:{
					school:{'banner':''},
					teacher:{},
					camera:{'url':''},
					member:{'url':''},
					timesection:[],
				},
				school:{
					content:'',
					contenturl:'',
					contenttype:'',
				},
				isshowfavor:false,
				isshowveryfy:false,
				isshowqrcode:false,
				isready:false,
				isfinish:false
			},
			created:function(){
				this.getLive();
				
			},
			methods:{
				getLive:function(e){
					let _this = this;
					$.get('detaildata.html',{live_id:live_id},function(res){
						_this.live = res.data;
						_this.getSchool(_this.live.school_id);
						if(res.code==1){
							$("#video").load();
						}else{
							_this.isshowfavor=false;
							_this.isshowveryfy=false;
							_this.isshowqrcode=false;
							if(res.error=="unfavor"){
								_this.isshowfavor = true;
								$.modal({
						          title: "友情提示",
						          text: "本监控需申请才可观看",
						          buttons: [
									{ text: "取消", className: "default"},
						            { text: "立即申请", 
						              onClick: function(){
						            	_this.doFavor();
						              }
						            }
						          ]
						        });
								return;
							}
							if(res.error=="unveryfy"){
								_this.isshowveryfy = true;
								return;
							}
							
							if(res.error=="unsubscribe"){
								_this.isshowqrcode = true;
								_this.doSubscribe();
								return;
							}
							
							if(res.error=="untime"){
								$.alert(res.msg, "友情提示");
								return;
							}
							
							$.alert(res.msg, "错误");
						}
						
						
					})
				},
				getSchool:function(school_id){
					let _this = this;
					$.get('/guanke/mobile.school/detaildata.html',{school_id:school_id},function(res){
						console.log(res.data);
						if(res.code==1){
							_this.school = res.data;
						}else{
							 $.alert("加载失败，请重新打开页面", "网速不给力");
						}
					})
				},
				doFavor:function(e){
					let _this = this;
					$.get('favor.html',{live_id:live_id,membervisibility:_this.live.membervisibility,camera_id:_this.live.camera_id},function(res){
						console.log(res);
						if(res.code==1){
							$.alert(res.msg, "友情提示");
							_this.isshowfavor = false;
							_this.isshowveryfy = false;
							_this.live.member.url = res.url;
							$("#video").load();
						}else{
							if(res.error=='unveryfy'){
								$.alert(res.msg, "友情提示");
								_this.isshowfavor = false;
								_this.isshowveryfy = true;
								return;
							}
							$.alert("加载失败，请重新打开页面", "网速不给力");
						}
					})
				},
				doSubscribe:function(e){
					let _this = this;
					if(_this.isshowqrcode){
						$.modal({
				          title: "友情提示",
				          text: '您尚未关注公众号，无法播放',
				          buttons: [
							{ text: "取消", className: "default"},
				            { text: "立即关注", 
				              onClick: function(){
				            	//if('{$wechat.history_url}'!=''){
				            	//	document.location.href = '{$wechat.history_url|raw}';
				            	//}else{
				            		$("#wechat").popup();
				            	//}
				              }
				            }
				          ]
				        });
					}else{
						$("#wechat").popup();
						return;
						
					}
				}
			}
		})

		function startplay(){
			$.get('/guanke/mobile.liveschool/startplay.html',{live_id:live_id},function(res){
				if(res.code!=1){
					 $.alert("加载失败，请重新打开页面", "网速不给力");
				}
			})
		}
</script>


{/block}
